<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../styles/wheel.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
    <script src="../js/Winwheel.js"></script>
    <title>Bon Appetit Wheel</title>
</head>
<body>
    <div class="wheel-container">
        <div class="triangle-pointer"></div>
        <canvas id="canvas" width="500" height="500"></canvas>
        <button id="spinButton" onclick="startSpin()">SPIN</button>
    </div>
    <script>
        let myWheel;

        function createWheel(segments) {
            console.log('Creating wheel with segments:', segments); // Debug log

            // Clear the canvas before creating a new wheel
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (segments.length === 0) {
                segments = ['Add Restaurants']; // Default segment when no restaurants are added
            }
            myWheel = new Winwheel({
                'canvasId': 'canvas',
                'numSegments': segments.length,
                'segments': segments.map((restaurant, index) => ({
                    'fillStyle': (index % 2 === 0) ? '#68aede' : '#9cd6ea',
                    'text': restaurant
                })),
                'animation': {
                    'type': 'spinToStop',
                    'duration': 5,
                    'spins': 8,
                    'callbackFinished': alertPrize
                }
            });

            console.log('Number of segments after creation:', myWheel.numSegments); // Debug log
        }

        function startSpin() {
            if (myWheel.numSegments > 1 || (myWheel.segments[1].text !== 'Add Restaurants')) {
                myWheel.startAnimation();
                document.getElementById('spinButton').disabled = true;
            } else {
                alert("Please add at least one restaurant to the list before spinning.");
            }
        }

        function alertPrize() {
            let winningSegment = myWheel.getIndicatedSegment();
            window.alert('Restaurant: ' + winningSegment.text);
            resetWheel();
        }

        function resetWheel() {
            myWheel.stopAnimation(false);
            myWheel.rotationAngle = 0;
            myWheel.draw();
            document.getElementById('spinButton').disabled = false;
        }

        window.addEventListener('message', (event) => {
            console.log('Message received:', event.data); // Debug log

            // Check if the message is coming from the same origin
            if (event.origin !== window.location.origin) {
                console.warn('Message received from unknown origin:', event.origin);
                return; // Exit if the message is from an untrusted origin
            }

            // Handle the message based on its type
            if (event.data && event.data.type === 'updateWheel') {
                console.log('Received updateWheel message:', event.data.restaurants); // Debug log
                createWheel(event.data.restaurants); // Update the wheel with the new restaurant list
            }
        });

        // Initial wheel setup with default segment
        createWheel([]);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../styles/wheel.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
    <script src="../js/Winwheel.js"></script>
    <title>Bon Appetit Wheel</title>
</head>
<body>
    <div class="wheel-container">
        <div class="triangle-pointer"></div>
        <canvas id="canvas" width="500" height="500"></canvas>
        <button id="spinButton" onclick="startSpin()">SPIN</button>
    </div>

    <script>
        let myWheel;

        function createWheel(segments) {
            // Clear the canvas before creating a new wheel
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (segments.length === 0) {
                segments = ['Add Restaurants']; // Default segment when no restaurants are added
            }
            myWheel = new Winwheel({
                'canvasId': 'canvas',
                'numSegments': segments.length,
                'segments': segments.map((restaurant, index) => ({
                    'fillStyle': (index % 2 === 0) ? '#68aede' : '#9cd6ea',
                    'text': restaurant
                })),
                'animation': {
                    'type': 'spinToStop',
                    'duration': 5,
                    'spins': 8,
                    'callbackFinished': alertPrize
                }
            });
        }

        function startSpin() {
            if (myWheel.numSegments === 1 && myWheel.segments[1].text === 'Add Restaurants') {
                parent.postMessage({ type: 'showAlert', title: 'Error', message: 'Please add at least one restaurant to the list before spinning.' }, '*');
            } else {
                myWheel.startAnimation();
                document.getElementById('spinButton').disabled = true;
            }
        }

        function alertPrize() {
            let winningSegment = myWheel.getIndicatedSegment();
            parent.postMessage({ type: 'showAlert', title: 'Congratulations!', message: 'Restaurant: ' + winningSegment.text }, '*');
            resetWheel();
        }

        function resetWheel() {
            myWheel.stopAnimation(false);
            myWheel.rotationAngle = 0;
            myWheel.draw();
            document.getElementById('spinButton').disabled = false;
        }

        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) {
                return;
            }

            if (event.data && event.data.type === 'updateWheel') {
                createWheel(event.data.restaurants);
            }
        });

        createWheel([]);
    </script>
</body>
</html>